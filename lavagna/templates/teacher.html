{% extends "layout.html" %}
{% block script %}

var student = new Object();
var questions = new Object();
var destination_student = null;
var destination_location = null;

function post_answer( e ) {
	var kind = $( '#kind' ).val();
	var answer = $( '#answer' ).val();
	if ( answer != '' ) $.post( '/post/answer', { 'answer': answer, 'kind': kind, 'destination': destination_location } );
	$( '#answer' ).val( '' );
}

function set_destination( student, location ) {
	destination_student.value = student;
	destination_location = location;
}

$( document ).ready( function () {

 	destination_student = document.getElementById( 'destination_student' );
 	set_destination( '*', '*' );
 
	$( 'td' ).mousemove( function ( event ) {
		if ( $(this)[ 0 ].id ) {
			s = student[ $(this)[ 0 ].id ];
			if ( !s ) return;
			q = questions[ $(this)[ 0 ].id ];
			qs = '<b>'+ student[ $(this)[ 0 ].id ] +'</b><ul>';
			for ( var i = 0; i < q.length; i++ ) qs += '<li>' + q[ i ];
			qs += '</ul>';
			$( '#tooltip' )[ 0 ].innerHTML = qs;
			$( '#tooltip' ).css( {
			    top: event.pageY + 5 + 'px',
				left: event.pageX + 5 + 'px'
			} ).show();
		}		
	} );
	$( 'td' ).mouseleave( function () {
		$( '#tooltip' ).hide();
	} );
	
	var source = new EventSource( '/stream/teacher' );
	source.onmessage = function( e ) {
		var d = JSON.parse( e.data );
		elem = document.getElementById( d.location );
		if ( ! elem ) return;
		if ( d.event == 'question' ) {
			questions[ d.location ].unshift( d.question );
			elem.innerHTML = questions[ d.location ].length;
			elem.classList.add( 'question' );
		} else if ( d.event == 'seat' ) {
			student[ d.location ] = d.student;
			questions[ d.location ] = new Array();
			elem.classList.add( 'seated' );
			$( elem ).click( function() {
				set_destination( d.student, d.location );
			} );
		}
	}
} );

{% endblock %}
{% block body %}

<div id="tooltip">&nbsp;</div>

<div id="maps">{{ rooms|safe }}</div>

<p>Hint:</p>
<form action="#" method="post">
	Destination: <input id="destination_student" type="text" disabled><button type="button" onclick="set_destination( '*', '*' ); return false;">broadcast</button><br/>
	<textarea rows=4 cols=80 id="answer"></textarea>
	<select id="kind">
		<option selected>text</option>
		<option>code</option>
		<option>html</option>
	</select>
	<button type="button" onclick="post_answer(); return false;">Post</button>
</form>

{% endblock %}

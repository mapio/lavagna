{% extends "layout.html" %}
{% block script %}

var student = new Object();
var questions = new Object();
var destination_student = null;
var destination_location = null;
var tooltip = null;

function post_answer( e ) {
	var kind = $( '#kind' ).val();
	var answer = $( '#answer' ).val();
	if ( answer != '' ) $.post( '/post/answer', { 'answer': answer, 'kind': kind, 'destination': destination_location } );
	$( '#answer' ).val( '' );
}

function set_destination( student, location ) {
	destination_student.value = student;
	destination_location = location;
}

$( document ).ready( function () {

	tooltip = document.getElementById( 'tooltip' );
 	destination_student = document.getElementById( 'destination_student' );
 	set_destination( '*', '*' );
 
	$( 'td' ).mousemove( function ( event ) {
		var id = $(this)[ 0 ].id;
		if ( id ) {
			s = student[ id ];
			if ( !s ) return;
			tooltip.innerHTML = '<b>'+ s +'</b>'
			if ( questions[ id ] != '' ) tooltip.innerHTML += '<ul>' + questions[ id ] + '</ul>';
			$( tooltip ).css( {
			    top: event.pageY + 5 + 'px',
				left: event.pageX + 5 + 'px'
			} ).show();
		}		
	} );
	$( 'td' ).mouseleave( function () {
		$( tooltip ).hide();
	} );
	
	var source = new EventSource( '/stream/teacher' );
	source.onmessage = function( e ) {
		var d = JSON.parse( e.data );
		var elem = document.getElementById( d.location );
		if ( ! elem ) return;
		if ( d.event == 'question' ) {
			questions[ d.location ] += '<li>' + d.question + '</li>';
			elem.innerHTML = elem.innerHTML == '&nbsp;' ? 1 : parseInt( elem.innerHTML ) + 1;
			elem.classList.add( 'question' );
		} else if ( d.event == 'seat' ) {
			student[ d.location ] = d.student;
			questions[ d.location ] = '';
			elem.classList.add( 'seated' );
			$( elem ).click( function() {
				set_destination( d.student, d.location );
			} );
			$( elem ).dblclick( function() {
				if ( elem.innerHTML != '&nbsp;' ) {
					elem.classList.remove( 'question' );
					elem.innerHTML = '&nbsp';
					questions[ d.location ] = '';
					$.post( '/post/clear_questions', { 	'location': d.location } );
				}
			} );
			
		}
	}
} );

{% endblock %}
{% block body %}

<div id="tooltip">&nbsp;</div>

<div id="maps">{{ rooms|safe }}</div>

<form action="#" method="post">
	Destination: <input id="destination_student" type="text" disabled><button type="button" onclick="set_destination( '*', '*' ); return false;">broadcast</button><br/>
	<textarea rows=4 cols=80 id="answer"></textarea>
	<select id="kind">
		<option selected>text</option>
		<option>code</option>
		<option>html</option>
	</select>
	<button type="button" onclick="post_answer(); return false;">Post</button>
</form>

{% endblock %}
